# Multi-Tenant Restaurant Management SaaS Platform

## Deployment Guide

### Prerequisites

- Ubuntu 22.04 LTS server
- PHP 8.2+ with extensions: mbstring, xml, bcmath, pdo_mysql, redis, gd
- Composer 2.x
- Node.js 18+ and npm
- MySQL 8.0+
- Nginx
- Supervisor (for queue workers)
- Redis (optional, for caching/queues)

---

## 1. Server Setup

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install PHP 8.2
sudo add-apt-repository ppa:ondrej/php -y
sudo apt install -y php8.2 php8.2-fpm php8.2-mbstring php8.2-xml php8.2-bcmath \
    php8.2-mysql php8.2-redis php8.2-gd php8.2-curl php8.2-zip

# Install MySQL 8
sudo apt install -y mysql-server
sudo mysql_secure_installation

# Install Nginx
sudo apt install -y nginx

# Install Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# Install Composer
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer

# Install Supervisor
sudo apt install -y supervisor

# Install Redis (optional)
sudo apt install -y redis-server
```

## 2. Database Setup

```bash
sudo mysql -u root -p

CREATE DATABASE restaurant_saas CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'saas_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON restaurant_saas.* TO 'saas_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

## 3. Application Deployment

```bash
# Clone or upload code
cd /var/www
git clone <your-repo-url> restaurant-saas
cd restaurant-saas

# Set permissions
sudo chown -R www-data:www-data /var/www/restaurant-saas
sudo chmod -R 775 storage bootstrap/cache

# Install dependencies
composer install --optimize-autoloader --no-dev
npm install
npm run build

# Environment setup
cp .env.example .env
php artisan key:generate
php artisan jwt:secret
```

### Configure `.env`

```env
APP_NAME="RestaurantSaaS"
APP_ENV=production
APP_DEBUG=false
APP_URL=https://yourdomain.com

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=restaurant_saas
DB_USERNAME=saas_user
DB_PASSWORD=your_secure_password

CACHE_STORE=redis
QUEUE_CONNECTION=redis
SESSION_DRIVER=redis

BROADCAST_CONNECTION=pusher
PUSHER_APP_ID=your_pusher_id
PUSHER_APP_KEY=your_pusher_key
PUSHER_APP_SECRET=your_pusher_secret
PUSHER_APP_CLUSTER=ap1

JWT_SECRET=<auto-generated>
JWT_TTL=1440
```

### Run Migrations & Seed

```bash
php artisan migrate --force
php artisan db:seed --class=TenantSeeder
php artisan storage:link
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

## 4. Nginx Configuration

```nginx
# /etc/nginx/sites-available/restaurant-saas
server {
    listen 80;
    server_name yourdomain.com;
    root /var/www/restaurant-saas/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    # API routes
    location /api {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Broadcasting
    location /broadcasting {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP handling
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # React SPA - serve from build
    location / {
        try_files $uri $uri/ /resources/js/index.html;
    }

    # Static assets
    location /build {
        alias /var/www/restaurant-saas/public/build;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

```bash
sudo ln -s /etc/nginx/sites-available/restaurant-saas /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### SSL with Let's Encrypt

```bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com
```

## 5. Supervisor (Queue Workers)

```ini
# /etc/supervisor/conf.d/restaurant-saas-worker.conf
[program:restaurant-saas-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/restaurant-saas/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/restaurant-saas/storage/logs/worker.log
stopwaitsecs=3600
```

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start restaurant-saas-worker:*
```

## 6. Scheduled Tasks (Cron)

```bash
# Add to crontab (sudo crontab -e -u www-data)
* * * * * cd /var/www/restaurant-saas && php artisan schedule:run >> /dev/null 2>&1
```

**Scheduled jobs:**
- `CheckSubscriptionExpiry` — Daily at 00:05
- `CalculateSettlement` — Monthly (1st) at 02:00

## 7. WebSocket Setup (Pusher)

1. Create a free account at [pusher.com](https://pusher.com)
2. Create a new Channels app
3. Copy credentials into `.env`
4. Events that broadcast:
   - `NewOrderCreated` → `tenant.{id}.orders` (private)
   - `OrderStatusUpdated` → `order.{orderNumber}` (public)
   - `MenuItemAvailabilityChanged` → `tenant.{id}.menu` (public)
   - `TableTransferred` → `tenant.{id}.tables` (private)

---

## Shared Hosting (cPanel) Deployment Guide

cPanel shared hosting has constraints: no root access, no Nginx, no Supervisor, no Redis. This guide adapts the deployment accordingly.

### Prerequisites

- cPanel shared hosting with **PHP 8.2+**
- MySQL (provided via cPanel)
- SSH access (recommended) or File Manager
- Local machine with Node.js 18+ (to build frontend assets before upload)

### Step 1: Build Frontend Locally

Build the React SPA on your local machine before uploading:

```bash
npm install
npm run build
```

This creates production assets in `public/build/`.

### Step 2: Directory Structure

cPanel uses `public_html` as the document root. Laravel's `public/` contents go there, and the rest of the app goes **above** `public_html`:

```
/home/yourusername/
├── restaurant-saas/          ← App code (NOT web-accessible)
│   ├── app/
│   ├── bootstrap/
│   ├── config/
│   ├── database/
│   ├── resources/
│   ├── routes/
│   ├── storage/
│   ├── vendor/
│   ├── .env
│   ├── artisan
│   └── composer.json
│
├── public_html/              ← Document root (web-accessible)
│   ├── build/                ← Vite build output
│   ├── assets/               ← Static assets (images, fonts, etc.)
│   ├── index.php             ← Laravel entry point (modified)
│   ├── index.html            ← React SPA entry (modified)
│   ├── .htaccess             ← Apache routing rules
│   └── robots.txt
```

**Upload instructions:**

1. Upload **everything except** `public/`, `node_modules/`, `.git/` to `/home/yourusername/restaurant-saas/`
2. Upload **contents of** `public/` to `/home/yourusername/public_html/`

### Step 3: Modify `public_html/index.php`

Edit `index.php` in `public_html` to point to the app directory above:

```php
<?php

use Illuminate\Http\Request;

define('LARAVEL_START', microtime(true));

// Determine if the application is in maintenance mode...
if (file_exists($maintenance = __DIR__.'/../restaurant-saas/storage/framework/maintenance.php')) {
    require $maintenance;
}

// Register the Composer autoloader...
require __DIR__.'/../restaurant-saas/vendor/autoload.php';

// Bootstrap Laravel and handle the request...
(require_once __DIR__.'/../restaurant-saas/bootstrap/app.php')
    ->handleRequest(Request::capture());
```

### Step 4: Create `.htaccess` in `public_html`

This handles both Laravel API routing and React SPA fallback:

```apache
<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Force HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # --- API & Backend Routes → Laravel (index.php) ---
    RewriteCond %{REQUEST_URI} ^/api/ [OR]
    RewriteCond %{REQUEST_URI} ^/broadcasting/ [OR]
    RewriteCond %{REQUEST_URI} ^/sanctum/ [OR]
    RewriteCond %{REQUEST_URI} ^/storage/
    RewriteRule ^ index.php [L]

    # --- Static build assets → Serve directly ---
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^ - [L]

    # --- Everything else (including /) → React SPA ---
    RewriteRule ^ index.html [L]
</IfModule>

# Ensure index.html is served before index.php for directory requests
DirectoryIndex index.html index.php
```

### Step 5: Copy Vite-Generated `index.html`

After `npm run build`, Vite generates `public/build/index.html` with the correct hashed asset references. **Copy this file** to `public_html/index.html`:

```bash
# Locally after build:
cp public/build/index.html public/index.html

# Then upload public/index.html to public_html/index.html on the server
```

Or via cPanel **File Manager**: copy `public_html/build/index.html` to `public_html/index.html`.

> **Important:** Do NOT manually create `index.html` — always use the Vite-generated one. It contains correct hashed filenames like `index-abc123.js` and `index-abc123.css`. Every time you run `npm run build`, you must copy the new `build/index.html` to `public_html/index.html`.

### Step 6: Configure `.env`

Create `.env` in `/home/yourusername/restaurant-saas/`:

```env
APP_NAME="RestaurantSaaS"
APP_ENV=production
APP_DEBUG=false
APP_URL=https://yourdomain.com

# Database (from cPanel → MySQL Databases)
DB_CONNECTION=mysql
DB_HOST=localhost
DB_PORT=3306
DB_DATABASE=yourusername_restaurant
DB_USERNAME=yourusername_dbuser
DB_PASSWORD=your_db_password

# Use file-based drivers (no Redis on shared hosting)
CACHE_STORE=file
QUEUE_CONNECTION=database
SESSION_DRIVER=file

# Pusher (optional)
BROADCAST_CONNECTION=pusher
PUSHER_APP_ID=your_pusher_id
PUSHER_APP_KEY=your_pusher_key
PUSHER_APP_SECRET=your_pusher_secret
PUSHER_APP_CLUSTER=ap1

JWT_SECRET=<generate-with-artisan>
JWT_TTL=1440
```

### Step 7: Database Setup via cPanel

1. Go to **cPanel → MySQL Databases**
2. Create a new database (e.g., `yourusername_restaurant`)
3. Create a new user with a strong password
4. Add user to database with **ALL PRIVILEGES**
5. Update `.env` with these credentials

### Step 8: Run Artisan Commands

Via **cPanel → Terminal** (or SSH):

```bash
cd ~/restaurant-saas

# Generate app key
php artisan key:generate

# Generate JWT secret
php artisan jwt:secret

# Run migrations
php artisan migrate --force

# Seed database
php artisan db:seed --class=DatabaseSeeder

# Create storage symlink (may need manual approach — see note below)
php artisan storage:link

# Cache config & routes for performance
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

> **Storage link note:** `php artisan storage:link` creates a symlink from `public/storage` → `storage/app/public`. On cPanel this should link `public_html/storage` → `restaurant-saas/storage/app/public`. If the default command doesn't work, create it manually:
> ```bash
> ln -s /home/yourusername/restaurant-saas/storage/app/public /home/yourusername/public_html/storage
> ```

### Step 9: Create Queue Jobs Table

Since we use `database` queue driver instead of Redis:

```bash
cd ~/restaurant-saas
php artisan queue:table
php artisan migrate --force
```

### Step 10: Cron Jobs via cPanel

1. Go to **cPanel → Cron Jobs**
2. Add a cron job that runs **every minute**:

```
* * * * * cd /home/yourusername/restaurant-saas && php artisan schedule:run >> /dev/null 2>&1
```

3. Add another cron job to process queued jobs (since we can't use Supervisor):

```
* * * * * cd /home/yourusername/restaurant-saas && php artisan queue:work database --stop-when-empty --max-time=55 >> /dev/null 2>&1
```

> This runs the queue worker every minute, processes available jobs, and stops before the next cron triggers. Not as fast as Supervisor but works on shared hosting.

### Step 11: PHP Version & Extensions

1. Go to **cPanel → MultiPHP Manager** or **Select PHP Version**
2. Set PHP version to **8.2** (or higher) for your domain
3. Enable required extensions: `mbstring`, `xml`, `bcmath`, `pdo_mysql`, `gd`, `curl`, `zip`, `fileinfo`

### Step 12: SSL Certificate\n\n1. Go to **cPanel → SSL/TLS** or **AutoSSL**\n2. Most hosts provide free AutoSSL (Let's Encrypt)\n3. HTTPS redirect is already included in the `.htaccess` above

### Step 13: File Permissions

Via cPanel **File Manager** or SSH:

```bash
cd ~/restaurant-saas
chmod -R 775 storage
chmod -R 775 bootstrap/cache
```

### cPanel vs VPS Comparison

| Feature | VPS (Nginx) | cPanel (Apache) |
|---------|-------------|-----------------|
| Web server | Nginx | Apache + .htaccess |
| Queue worker | Supervisor (persistent) | Cron every minute |
| Cache/Session | Redis | File-based |
| PHP management | Manual install | MultiPHP Manager |
| SSL | Certbot | AutoSSL |
| Process control | Full root access | Limited, cPanel only |
| WebSockets | Native support | Pusher/Ably (external only) |
| Performance | Higher | Adequate for small-mid |

### Troubleshooting (cPanel)

**500 Internal Server Error:**
- Check `storage/logs/laravel.log`
- Verify file permissions on `storage/` and `bootstrap/cache/`
- Ensure `.env` exists and has correct DB credentials
- Run `php artisan config:clear` then `php artisan config:cache`

**API returns 404:**
- Verify `.htaccess` exists in `public_html` and `mod_rewrite` is enabled
- Check that `index.php` paths point to correct `restaurant-saas/` directory

**React app shows blank page:**
- Check browser console for JS errors
- Verify `build/` folder was uploaded to `public_html/build/`
- Confirm `index.html` references correct built asset filenames from `manifest.json`

**Queue jobs not processing:**
- Verify cron job is set up in cPanel
- Check `php artisan queue:work` runs without error via SSH
- Ensure `jobs` table exists: `php artisan queue:table && php artisan migrate`

**Storage/uploads not working:**
- Verify symlink: `public_html/storage` → `restaurant-saas/storage/app/public`
- Create manually if `php artisan storage:link` fails

---

## API Overview

### Authentication
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/auth/login` | Login, returns JWT |
| POST | `/api/auth/register` | Register |
| POST | `/api/auth/logout` | Logout |
| POST | `/api/auth/refresh` | Refresh token |
| GET | `/api/auth/me` | Current user |

### Customer (Public)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/restaurant/{slug}` | Restaurant info |
| GET | `/api/restaurant/{slug}/menu` | Browse menu |
| GET | `/api/restaurant/{slug}/table/{tableId}` | Table info |
| POST | `/api/restaurant/{slug}/voucher/validate` | Validate voucher |
| POST | `/api/orders` | Place order |
| GET | `/api/orders/{orderNumber}/track` | Track order |

### Dashboard (Authenticated + Tenant)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET/POST | `/api/menu-items` | CRUD menu items |
| PATCH | `/api/menu-items/{id}/toggle` | Toggle availability |
| GET/POST | `/api/categories` | CRUD categories |
| GET/POST | `/api/tables` | CRUD tables |
| POST | `/api/tables/transfer` | Transfer table |
| GET | `/api/tables/{id}/qr-code` | Generate QR |
| GET/POST | `/api/vouchers` | CRUD vouchers |
| GET | `/api/orders` | List orders |
| PATCH | `/api/orders/{id}/status` | Update status |
| GET/POST | `/api/users` | Staff management |
| GET | `/api/kitchen/active` | Kitchen display |
| POST | `/api/kitchen/{id}/advance` | Advance order |

### Reports & Settlements
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/reports/sales` | Sales report |
| GET | `/api/reports/vouchers` | Voucher report |
| GET | `/api/reports/tables` | Table performance |
| GET | `/api/reports/comparison` | Year-over-year |
| GET | `/api/reports/settlements` | Settlement report |
| GET | `/api/settlements` | Settlement list |
| POST | `/api/settlements/{id}/payment` | Record payment |

### Super Admin
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET/POST | `/api/admin/tenants` | Manage tenants |
| POST | `/api/admin/tenants/onboard` | Onboard new tenant |
| GET/POST | `/api/admin/subscriptions` | Manage subscriptions |
| GET | `/api/admin/dashboard` | Platform stats |

---

## Default Demo Credentials

After seeding with `TenantSeeder`:

| Role | Email | Password |
|------|-------|----------|
| Super Admin | `superadmin@system.com` | `password` |
| Restaurant Admin | `admin@tastybites.com` | `password` |
| Staff | `staff@tastybites.com` | `password` |
| Kitchen | `kitchen@tastybites.com` | `password` |

---

## Architecture Notes

- **Multi-tenancy**: Row-level isolation using `tenant_id` foreign key + global scope
- **Auth**: JWT tokens with `tenant_id` and `role` in custom claims
- **Order flow**: placed → confirmed → preparing → ready → served → completed
- **WiFi IP validation**: Optional per-tenant, validated against `authorized_wifi_ip`
- **Subscription billing**: Monthly/yearly plans, auto-deactivation on expiry
- **Settlement**: Platform-collection mode tracks commissions and payable balances
- **QR Ordering**: Generates URLs like `/restaurant/{slug}?table={id}`
